from flask import Flask
from flask_restful import Resource, Api
from flask_cors import CORS
from api.helper_functions import get_data, date, clean_data, corelation
from io import BytesIO
import pandas as pd
import numpy as np


app = Flask(__name__)
api = Api(app)
CORS(app)

class seki(Resource):
    def get(self,table_id):
        f = get_data(table_id.upper())
        sheets = f.sheet_names
        df = f.parse(len(sheets)-1)
        cleaned_data = clean_data(df)
        res = cleaned_data.to_json(orient ='split')
        return res

class forecast(Resource):
    def post(self):
        data1 = np.array([2073859.77,2066480.99,2112082.7000000002,2116023.54,2143234.0499999998,2231144.3300000001,2217588.8100000001,2236459.4500000002,2274954.5699999998,2308845.9700000002,2347806.8599999999,2471205.79,2436678.9500000002,2420191.1400000001,2451356.9199999999,2434478.3900000001,2475285.98,2522783.8100000001,2564556.1299999999,2621345.7400000002,2643331.4500000002,2677786.9300000002,2729538.27,2877219.5699999998,2857126.9300000002,2852004.9399999999,2914194.4700000002,2929610.3700000001,2994474.3900000001,3052786.1000000001,3057335.75,3091568.4900000002,3128179.27,3164443.1499999999,3207908.29,3307507.5499999998,3268789.1499999999,3280420.25,3322528.96,3360928.0699999998,3426304.9199999999,3413378.6600000001,3506573.6000000001,3502419.7999999998,3584080.54,3576869.3500000001,3616049.2000000002,3730409.3500000001,3652349.2799999998,3635060.3799999999,3652530.5499999998,3721882.3799999999,3780955.2799999998,3857961.77,3887407.48,3886519.9700000002,4010146.6600000001,4024488.8700000001,4076669.8799999999,4173326.5,4174825.9100000001,4218122.7599999998,4246361.1900000004,4275711.1100000003,4288369.2599999998,4358801.5099999998,4373208.0999999996,4404085.0300000003,4508603.1699999999,4443078.0800000001,4452324.6500000004,4548800.2699999996,4498361.2800000003,4521951.2000000002,4561872.5199999996,4581877.8700000001,4614061.8200000003,4737451.2300000004,4730379.6799999997,4746026.6799999997,4737630.7599999998,4778478.8899999997,4868651.1600000001,5004976.79,4936881.9900000002,4942919.7599999998,5017643.5499999998,5033780.29,5126370.1500000004,5225165.7599999998,5178078.75,5219647.6299999999,5254138.5099999998,5284320.1600000001,5321431.7699999996,5419165.0499999998,5351684.6699999999,5351650.3300000001,5395826.04,5409088.8099999996,5435082.9299999997,5534149.8300000001,5507791.75,5529451.8099999996,5606779.8899999997,5667512.0999999996,5670975.2400000002,5760046.2000000002,5644985.1699999999,5670777.5700000003,5747246.8200000003,5746731.7699999996,5860508.75,5908509.2699999996,5941133.0999999996,5934561.5099999998,6004277.1699999999,6026908.5,6074377.0199999996,6136776.54,6047998.5599999996,6118513.75,6441495.2300000004,6236651.0199999996,6465361.6299999999,6391611.8600000003,6566671.3399999999,6730993.7400000002,6748814.3399999999,6782146.9800000004,6821198.0599999996,6905939.2999999998,6767407.6480999999,6817787.9060000004,6895564.1188000003,6964386.4943000004,7004093.0763999997,7130061.4186000004,7160560.3326000003,7211500.7197000002,7300920.6358000003,7491704.3761,7573319.8980999999,7870452.8529000003,7646789.1900000004,7690134.5,7810949.3200000003,7911484.4900000002,7854186.71,7890747.0099999998,7845551.9100000001,7897628.21,7962693.3600000003,8223055.0199999996,8297349.5099999998,8528022.3100000005,8271838.0977999996,8300648.3739999998,8293283.2271999996])
        data2 = np.array([547457.45,540740.4399999999,540696.95,525923.58,531309.3199999999,522552.09,515995.41,521234.59,523137.6,518008.92,525104.23,514143.03,355797.18,310741.49,318000.78,252126.55,223667.39,216791.12,216081.39,214448.56,237642.61,257584.29,244644.09,351177.33,322215.77,296137.1,297107.86,243123.08,240053.49,284331.25,279039.87,271398.04,298897.14,285783.66,313324.51,389826.5,378366.01,361336.69,366901.94,341302.34,322822.39,330870.79,377079.88,340331.67,342433.27,337225.17,353754.96,406610.61,345702.4,318677.11,308622.85,314113.7,290773.07,325311.73,293691.1,306327.67,345765.13,380011.23,394515.37,416608.2,363457.78,382649.84,426449.43,417440.98,365073.72,408231.74,407277.56,420750.48,482396.22,495479.68,520858.3,491127.2,532951.24,563544.35,517321.77,513238.8,542179,511216.77,502254.86,486276.65,410537.6,442063.98,508967.51,519065.06,507172.24,485638.49,445404.36,393804.5,442960.61,464804.38,448191.1,458274.58,463549.63,503524.49,518698.35,488862.44,528311.85,530355.28,471641.43,427323.75,421367.32,462120.01,471914.73,445236.33,484358.28,486943.16,500608.07,472728.73,438307.93,386108.25,425782.39,450741.08,441422.57,403058.7,428034.48,429159.95,447471.86,438260.85,512830.26,489172.81,433340.69,431084.18,486688.46,457426.28,489130.41,575286.47,601872.16,707777.41,789835.66,795004.39,853966.04,818392.22,672415.69751,651401.9723800001,692117.8209,664444.44073,764942.2818699999,797332.56119,835832.87271,858308.00184,917980.5081100001,1037347.405,1113438.5315,1127266.5358,996317.72,929877.9399999999,885832.95,813009.1899999999,794737.08,685882.65,743483.22,666036.72,619768.76,862976.1800000001,921694.8199999999,970957.4300000001,792425.3843799999,747331.32907,658462.20076])  # Dependent variable
        res = corelation(data1,data2)
        return res
    
    

api.add_resource(seki, '/<string:table_id>')
api.add_resource(forecast,'/forecast')

if __name__ == '__main__':
    app.run(debug=True)
